<?xml version="1.0" encoding="utf-8"?>
<UserControl
	x:Name="Root"
	x:Class="RemoteLogViewer.Views.Ssh.FileViewer.TextFileViewer"
	xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
	xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
	xmlns:sys="using:System"
	xmlns:controls="using:CommunityToolkit.WinUI.Controls"
	xmlns:models="using:RemoteLogViewer.Models.Ssh.FileViewer"
	xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
	mc:Ignorable="mc">
	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="auto"/>
			<RowDefinition Height="2*" MinHeight="100"/>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*" MinHeight="100"/>
		</Grid.RowDefinitions>
		<StackPanel Orientation="Horizontal" Spacing="8" Margin="4" VerticalAlignment="Center">
			<TextBlock Text="ファイル:"/>
			<TextBlock Text="{x:Bind ViewModel.OpenedFilePath.Value, Mode=OneWay}" FontWeight="SemiBold" />
			<TextBlock Text=" 行数:"/>
			<TextBlock Text="{x:Bind ViewModel.TotalLines.Value, Mode=OneWay}"/>
			<TextBlock Text=" 表示開始行:"/>
			<TextBlock Text="{x:Bind ViewModel.WindowStartLine.Value, Mode=OneWay}"/>
			<TextBlock Text=" 表示可能行数:"/>
			<TextBlock Text="{x:Bind ViewModel.VisibleLineCount.Value, Mode=OneWay}"/>
			<TextBlock Text=" Encoding:"/>
			<AutoSuggestBox Width="160" ItemsSource="{x:Bind ViewModel.AvailableEncodings}" Text="{x:Bind ViewModel.SelectedEncoding.Value, Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}"/>
			<TextBlock Text=" 読込:"/>
			<ProgressBar Width="120" Height="14" Minimum="0" Maximum="1" Value="{x:Bind ViewModel.FileLoadProgress.Value, Mode=OneWay}"/>
			<StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
				<TextBlock Text="|" Opacity="0.4"/>
				<TextBox x:Name="StartLineBox" Width="80" PlaceholderText="Start"/>
				<TextBox x:Name="EndLineBox" Width="80" PlaceholderText="End"/>
				<Button Content="Save Range" Click="SaveRangeButton_Click"/>
			</StackPanel>
		</StackPanel>

		<Grid Grid.Row="1" RowDefinitions="*" ColumnDefinitions="Auto,*,Auto">
			<ScrollViewer x:Name="LineViewer"
				VerticalScrollBarVisibility="Hidden"
				HorizontalScrollBarVisibility="Hidden"
				Padding="0,8"
				PointerWheelChanged="ContentViewer_PointerWheelChanged">
				<ItemsControl ItemsSource="{x:Bind ViewModel.LineNumbers.Value, Mode=OneWay}"
					PointerWheelChanged="ContentViewer_PointerWheelChanged">
					<ItemsControl.ItemTemplate>
						<DataTemplate x:DataType="sys:Int64">
							<Grid Height="16">
								<Border Background="#0D000000" Padding="4,0" Margin="0,0,4,0" Width="{Binding ViewModel.LineNumberColumnWidth.Value, ElementName=Root, Mode=OneWay}">
									<TextBlock Text="{x:Bind }" IsTextSelectionEnabled="True" FontFamily="Consolas" Foreground="Gray" HorizontalAlignment="Right"/>
								</Border>
							</Grid>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>
			<ScrollViewer x:Name="ContentViewer"
				Grid.Column="1"
				VerticalScrollBarVisibility="Hidden"
				HorizontalScrollBarVisibility="Auto"
				Padding="0,8"
				SizeChanged="ContentViewer_SizeChanged"
				PointerWheelChanged="ContentViewer_PointerWheelChanged">
				<ItemsControl ItemsSource="{x:Bind ViewModel.Lines, Mode=OneWay}"
					PointerWheelChanged="ContentViewer_PointerWheelChanged">
					<ItemsControl.ItemTemplate>
						<DataTemplate x:DataType="models:TextLine">
							<Grid ColumnDefinitions="60, *" HorizontalAlignment="Stretch" Height="16">
								<ProgressRing Width="14" Height="14" Margin="0,1,8,1" IsActive="True" VerticalAlignment="Center" Visibility="{x:Bind IsLoaded, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
								<TextBlock Grid.Column="1" Height="16" Text=" " HorizontalAlignment="Stretch"/>
								<TextBlock Grid.ColumnSpan="2" Height="16" Text="{x:Bind Content}" Visibility="{x:Bind IsLoaded, Converter={StaticResource BooleanToVisibilityConverter}}" IsTextSelectionEnabled="True" FontFamily="Consolas"/>
							</Grid>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>
			<ScrollViewer x:Name="VirtualScrollViewer"
				Height="{x:Bind ViewModel.ViewerHeight.Value, Mode=OneWay, Converter={StaticResource LongToDoubleConverter}}"
				Grid.Column="2"
				VerticalScrollBarVisibility="Visible"
				HorizontalScrollBarVisibility="Disabled"
				Background="Transparent"
				Padding="0"
				IsTabStop="False"
				ViewChanged="VirtualScrollViewer_ViewChanged">
				<Grid x:Name="Kari" Height="{x:Bind ViewModel.TotalHeight.Value, Mode=OneWay,Converter={StaticResource LongToDoubleConverter}}" />
			</ScrollViewer>
		</Grid>
		<controls:GridSplitter Grid.Row="2"
                               VerticalAlignment="Top"
						   ResizeDirection="Rows"
						   ResizeBehavior="PreviousAndNext"
						   HorizontalAlignment="Stretch"
						   Margin="0,5,0,0">
			<controls:GridSplitter.RenderTransform>
				<TranslateTransform Y="-7" />
			</controls:GridSplitter.RenderTransform>
		</controls:GridSplitter>

		<Grid Grid.Row="3" RowDefinitions="Auto,*" Padding="0,8" CornerRadius="4">
			<StackPanel Orientation="Horizontal" Spacing="8">
				<TextBox Width="260" PlaceholderText="grep pattern" Text="{x:Bind ViewModel.GrepQuery.Value, Mode=TwoWay}"/>
				<Button Content="Search" Command="{x:Bind ViewModel.GrepCommand}" Visibility="{x:Bind ViewModel.IsGrepRunning.Value, Mode=OneWay, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
				<Button Content="Cancel" Command="{x:Bind ViewModel.GrepCancelCommand}" Visibility="{x:Bind ViewModel.IsGrepRunning.Value, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"/>
				<ProgressBar Width="120" Height="14" Minimum="0" Maximum="1" Value="{x:Bind ViewModel.GrepProgress.Value, Mode=OneWay}" Visibility="{x:Bind ViewModel.IsGrepRunning.Value, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"/>
				<TextBlock Text="結果:"/>
				<TextBlock Text="{x:Bind ViewModel.GrepResults.Count, Mode=OneWay}"/>
			</StackPanel>
			<ScrollViewer
				Grid.Row="1"
				VerticalScrollBarVisibility="Auto"
				Padding="0,8"
				HorizontalScrollBarVisibility="Auto"
				PointerWheelChanged="ContentViewer_PointerWheelChanged">
				<ItemsControl ItemsSource="{x:Bind ViewModel.GrepResults}">
					<ItemsControl.ItemTemplate>
						<DataTemplate x:DataType="models:TextLine">
							<Grid ColumnDefinitions="Auto,*" MinHeight="16">
								<Border Background="#0D000000" Padding="4,0" Margin="0,0,4,0" Width="{Binding ViewModel.LineNumberColumnWidth.Value, ElementName=Root, Mode=OneWay}">
									<HyperlinkButton Content="{x:Bind LineNumber}" Click="GrepResultLineButton_Click" Padding="0" MinWidth="0" HorizontalAlignment="Right" FontFamily="Consolas"/>
								</Border>
								<TextBlock Grid.Column="1" Text="{x:Bind Content}" IsTextSelectionEnabled="True" FontFamily="Consolas"/>
							</Grid>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>
		</Grid>
	</Grid>
</UserControl>
